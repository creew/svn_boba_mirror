###############################################################################
#                                                                             #
#     IAR Systems ARM Assembler V4.40A/W32 22/Aug/2006  13:39:32              #
#     Copyright 1999-2006 IAR Systems. All rights reserved.                   #
#                                                                             #
#           Source file   =  E:\ARM\elfloader\ELFLoader\IMB.asm               #
#           List file     =  E:\ARM\elfloader\ELFLoader\Release\List\IMB.lst  #
#           Object file   =  E:\ARM\elfloader\ELFLoader\Release\Obj\IMB.r79   #
#           Command line  =  E:\ARM\elfloader\ELFLoader\IMB.asm               #
#                            -OE:\ARM\elfloader\ELFLoader\Release\Obj\ -s+    #
#                            -M<> -w+                                         #
#                            -LE:\ARM\elfloader\ELFLoader\Release\List\ -cE   #
#                            -t8 --cpu ARM926EJ-S --fpu None                  #
#                            -ID:\IARARM\ARM\INC\                             #
#                                                                             #
###############################################################################

    1    00000000                      RSEG    CODE:CODE(2)
    2    00000000              
    3    00000000              ;       PUBLIC OldOnCreate
    4    00000000              ;OldOnCreate    EQU     0xA02FCB52+1
    5    00000000              
    6    00000000              ;       PUBLIC OldOnClose
    7    00000000              ;OldOnClose     EQU     0xA02FCD7A+1   
                                
    8    00000000              ;
    9    00000000                      PUBLIC  ExecuteIMB
   10    00000000              
   11    00000000              ExecuteIMB:
   12    00000000 04E02DE5             STR     LR,[SP, #-4]!
   13    00000004 00200FE1             MRS     R2,CPSR
   14    00000008 040000EF             SWI     4               ; Переключаемся
                                                                в системный
                                                                режим
   15    0000000C 00100FE1             MRS     R1,CPSR         ; Запрещаем
                                                                прерывания
   16    00000010 C01081E3             ORR     R1,R1,#0xC0
   17    00000014 01F021E1             MSR     CPSR_c,R1
   18    00000018 0000A0E1             NOP
   19    0000001C 0000A0E1             NOP
   20    00000020 0000A0E1             NOP
   21    00000024              ;Выполняем необходимую требуху с кешем
   22    00000024              clean_loop:
   23    00000024 7AFF17EE             MRC     p15, 0, r15, c7, c10, 3 ; clean
                                                     entire dcache using test
                                                     and clean
   24    00000028 0000A0E1             NOP
   25    0000002C 0000A0E1             NOP
   26    00000030 0000A0E1             NOP
   27    00000034 FAFFFF1A             BNE     clean_loop
   28    00000038 0000A0E3             MOV     R0,#0
   29    0000003C 9A0F07EE             MCR     p15, 0, r0, c7, c10, 4 ; drain
                                                     write buffer
   30    00000040 0000A0E1             NOP
   31    00000044 0000A0E1             NOP
   32    00000048 0000A0E1             NOP
   33    0000004C 0000A0E1             NOP
   34    00000050 150F07EE             MCR     p15, 0, r0, c7, c5, 0 ;
                                                     invalidate icache
   35    00000054 0000A0E1             NOP
   36    00000058 0000A0E1             NOP
   37    0000005C 0000A0E1             NOP
   38    00000060 0000A0E1             NOP
   39    00000064              ;Выходим
   40    00000064 02F021E1             MSR     CPSR_c,R2       ; Восстанавливае
                                                               м старый
                                                                режим
   41    00000068 04F09DE4             LDR     PC,[SP], #+0x4
   42    0000006C                      
   43    0000006C                      END
##############################
#          CRC:E3CA          #
#        Errors:   0         #
#        Warnings: 0         #
#         Bytes: 108         #
##############################



