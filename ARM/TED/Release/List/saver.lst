##############################################################################
#                                                                            #
# IAR ARM ANSI C/C++ Compiler V4.40A/W32 EVALUATION    24/Sep/2006  17:16:09 #
# Copyright 1999-2005 IAR Systems. All rights reserved.                      #
#                                                                            #
#    Cpu mode        =  interwork                                            #
#    Endian          =  little                                               #
#    Stack alignment =  4                                                    #
#    Source file     =  E:\ARM\TED\saver.c                                   #
#    Command line    =  E:\ARM\TED\saver.c -lC E:\ARM\TED\Release\List\ -o   #
#                       E:\ARM\TED\Release\Obj\ -s9 --no_unroll              #
#                       --no_clustering --cpu_mode arm --endian little       #
#                       --cpu ARM926EJ-S --stack_align 4 --interwork -e      #
#                       --fpu None -I D:\IARARM\ARM\INC\                     #
#    List file       =  E:\ARM\TED\Release\List\saver.lst                    #
#    Object file     =  E:\ARM\TED\Release\Obj\saver.r79                     #
#                                                                            #
#                                                                            #
##############################################################################

E:\ARM\TED\saver.c
      1          #include "E:\ARM\swilib.h"
      2          
      3          extern unsigned int STKSZ;
      4          extern unsigned int STKSZ50;
      5          
      6          extern int u_disk; //Дисковый указатель верхнего стека (в блоках по STKSZ50)
      7          extern int d_disk; //Дисковый указатель нижнего стека (в блоках по STKSZ50)
      8          extern unsigned int usp; //Указатель на верхний стек
      9          extern unsigned int dsp; //Указатель на нижний стек
     10          extern unsigned int dbat[]; //Таблица распределения блоков нижнего стека во временном файле
     11          extern unsigned int ubat[]; //Таблица распределения блоков верхнего стека во временном файлe
     12          extern char stkfile[];
     13          extern char filename[];
     14          
     15          extern char *dstk;
     16          extern char *ustk;
     17          
     18          extern volatile int disk_access;
     19          
     20          extern unsigned int bl_ds(unsigned int pos);
     21          
     22          extern int terminated; //Признак закрытия диалога
     23          extern volatile unsigned int draw_mode;
     24          
     25          extern void DiskErrorMsg(int mode);
     26          
     27          #define flush_obuf(FILEH,P) {if (P>=STKSZ50) {if (fwrite(FILEH,obuf,P,&ul)!=P) DiskErrorMsg(4); P=0;}}
     28          

   \                                 In segment CODE, align 4, keep-with-next
     29          void savetext(void)
     30          {
   \                     savetext:
   \   00000000   F04F2DE9           PUSH     {R4-R11,LR}
     31            char *ibuf;
     32            char *obuf;
     33          
     34            int sf;
     35            int f;
     36            unsigned int p;
     37            unsigned int ul;
     38            int i;
     39            char c;
     40            unsigned int seekpos;
     41          
     42            if (!(ibuf=malloc(STKSZ50))) goto LERR1;
   \   00000004   5C639FE5           LDR      R6,??savetext_0  ;; STKSZ50
   \   00000008   04D04DE2           SUB      SP,SP,#+4
   \   0000000C   000096E5           LDR      R0,[R6, #+0]
   \   00000010   140000EF           SWI      +20
   \   00000014   0040B0E1           MOVS     R4,R0
   \   00000018   C500000A           BEQ      ??savetext_1
     43            if (!(obuf=malloc(STKSZ50))) goto LERR1;
   \   0000001C   000096E5           LDR      R0,[R6, #+0]
   \   00000020   140000EF           SWI      +20
   \   00000024   0050B0E1           MOVS     R5,R0
   \   00000028   C100000A           BEQ      ??savetext_1
     44          
     45            f=fopen(filename,A_ReadWrite+A_BIN+A_Create+A_Truncate,P_READ+P_WRITE,&ul); //Создаем выходной файл
   \   0000002C   38039FE5           LDR      R0,??savetext_0+0x4  ;; filename
   \   00000030   0D30A0E1           MOV      R3,SP
   \   00000034   602FA0E3           MOV      R2,#+384
   \   00000038   0210A0E3           MOV      R1,#+2
   \   0000003C   831C81E3           ORR      R1,R1,#0x8300
   \   00000040   0A0000EF           SWI      +10
   \   00000044   0070A0E1           MOV      R7,R0
     46            if (f==-1)
   \   00000048   010077E3           CMN      R7,#+1
   \   0000004C   0200001A           BNE      ??savetext_2
     47            {
     48              DiskErrorMsg(4);
   \   00000050   0400A0E3           MOV      R0,#+4
   \   00000054   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
   \   00000058   B50000EA           B        ??savetext_1
     49              goto LERR1;
     50            }
     51            sf=fopen(stkfile,A_ReadOnly+A_BIN,0,&ul); //Файл верхнего стека
   \                     ??savetext_2:
   \   0000005C   0C039FE5           LDR      R0,??savetext_0+0x8  ;; stkfile
   \   00000060   0D30A0E1           MOV      R3,SP
   \   00000064   0020A0E3           MOV      R2,#+0
   \   00000068   801CA0E3           MOV      R1,#+32768
   \   0000006C   0A0000EF           SWI      +10
   \   00000070   0080A0E1           MOV      R8,R0
     52            if (f==-1)
     53            {
     54              DiskErrorMsg(3);
     55              goto LERR2;
     56            }
     57          
     58            i=0;
   \   00000074   00A0A0E3           MOV      R10,#+0
   \   00000078   0D90A0E3           MOV      R9,#+13
   \   0000007C   100000EA           B        ??savetext_3
     59            while(i<=u_disk)
     60            {
     61              //Пишем верхний стек непосредственно
     62              p=ubat[i++];
     63              seekpos=STKSZ50*p;
     64              if (lseek(sf,seekpos,0,&ul,&ul)!=seekpos) DiskErrorMsg(2);
     65              if (fread(sf,ibuf,STKSZ50,&ul)!=STKSZ50) DiskErrorMsg(0);
     66              p=0;
     67              while(p!=STKSZ50)
     68              {
     69                if (!ibuf[p]) ibuf[p]=0x0D;
   \                     ??savetext_4:
   \   00000080   040081E0           ADD      R0,R1,R4
   \   00000084   0020D0E5           LDRB     R2,[R0, #+0]
     70                p++;
   \   00000088   011081E2           ADD      R1,R1,#+1
   \   0000008C   000052E3           CMP      R2,#+0
   \   00000090   0090C005           STRBEQ   R9,[R0, #+0]
     71              }
   \                     ??savetext_5:
   \   00000094   002096E5           LDR      R2,[R6, #+0]
   \   00000098   020051E1           CMP      R1,R2
   \   0000009C   F7FFFF1A           BNE      ??savetext_4
     72              if (fwrite(f,ibuf,STKSZ50,&ul)!=STKSZ50) DiskErrorMsg(4);
   \   000000A0   0D30A0E1           MOV      R3,SP
   \   000000A4   0410A0E1           MOV      R1,R4
   \   000000A8   0700A0E1           MOV      R0,R7
   \   000000AC   0C0000EF           SWI      +12
   \   000000B0   001096E5           LDR      R1,[R6, #+0]
   \   000000B4   010050E1           CMP      R0,R1
   \   000000B8   0100000A           BEQ      ??savetext_3
   \   000000BC   0400A0E3           MOV      R0,#+4
   \   000000C0   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
   \                     ??savetext_3:
   \   000000C4   A8029FE5           LDR      R0,??savetext_0+0xC  ;; u_disk
   \   000000C8   000090E5           LDR      R0,[R0, #+0]
   \   000000CC   0A0050E1           CMP      R0,R10
   \   000000D0   1C0000BA           BLT      ??savetext_6
   \   000000D4   9C029FE5           LDR      R0,??savetext_0+0x10  ;; ubat
   \   000000D8   001096E5           LDR      R1,[R6, #+0]
   \   000000DC   0A0190E7           LDR      R0,[R0, +R10, LSL #+2]
   \   000000E0   01A08AE2           ADD      R10,R10,#+1
   \   000000E4   90010BE0           MUL      R11,R0,R1
   \   000000E8   0D00A0E1           MOV      R0,SP
   \   000000EC   01002DE9           PUSH     {R0}
   \   000000F0   04308DE2           ADD      R3,SP,#+4
   \   000000F4   0020A0E3           MOV      R2,#+0
   \   000000F8   0B10A0E1           MOV      R1,R11
   \   000000FC   0800A0E1           MOV      R0,R8
   \   00000100   0F0000EF           SWI      +15
   \   00000104   0B0050E1           CMP      R0,R11
   \   00000108   04D08DE2           ADD      SP,SP,#+4
   \   0000010C   0100000A           BEQ      ??savetext_7
   \   00000110   0200A0E3           MOV      R0,#+2
   \   00000114   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
   \                     ??savetext_7:
   \   00000118   002096E5           LDR      R2,[R6, #+0]
   \   0000011C   0D30A0E1           MOV      R3,SP
   \   00000120   0410A0E1           MOV      R1,R4
   \   00000124   0800A0E1           MOV      R0,R8
   \   00000128   0B0000EF           SWI      +11
   \   0000012C   001096E5           LDR      R1,[R6, #+0]
   \   00000130   010050E1           CMP      R0,R1
   \   00000134   0100000A           BEQ      ??savetext_8
   \   00000138   0000A0E3           MOV      R0,#+0
   \   0000013C   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
   \                     ??savetext_8:
   \   00000140   0010A0E3           MOV      R1,#+0
   \   00000144   D2FFFFEA           B        ??savetext_5
     73            }
     74            //Пишем верхний стек из ОЗУ
     75            p=0;
   \                     ??savetext_6:
   \   00000148   00B0A0E3           MOV      R11,#+0
     76            i=0;
   \   0000014C   00A0A0E3           MOV      R10,#+0
   \   00000150   140000EA           B        ??savetext_9
     77            while(p!=usp)
     78            {
     79              c=ustk[p];
   \                     ??savetext_10:
   \   00000154   20029FE5           LDR      R0,??savetext_0+0x14  ;; ustk
   \   00000158   000090E5           LDR      R0,[R0, #+0]
   \   0000015C   0000DBE7           LDRB     R0,[R11, +R0]
     80              if (!c) c=0x0D;
   \   00000160   0010B0E1           MOVS     R1,R0
   \   00000164   0D00A003           MOVEQ    R0,#+13
     81              obuf[i]=c;
   \   00000168   0500CAE7           STRB     R0,[R10, +R5]
     82              i++;
     83              flush_obuf(f,i);
   \   0000016C   000096E5           LDR      R0,[R6, #+0]
   \   00000170   01A08AE2           ADD      R10,R10,#+1
   \   00000174   00005AE1           CMP      R10,R0
   \   00000178   0900003A           BCC      ??savetext_11
   \   0000017C   0D30A0E1           MOV      R3,SP
   \   00000180   0A20A0E1           MOV      R2,R10
   \   00000184   0510A0E1           MOV      R1,R5
   \   00000188   0700A0E1           MOV      R0,R7
   \   0000018C   0C0000EF           SWI      +12
   \   00000190   0A0050E1           CMP      R0,R10
   \   00000194   0100000A           BEQ      ??savetext_12
   \   00000198   0400A0E3           MOV      R0,#+4
   \   0000019C   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
   \                     ??savetext_12:
   \   000001A0   00A0A0E3           MOV      R10,#+0
     84              p++;
   \                     ??savetext_11:
   \   000001A4   01B08BE2           ADD      R11,R11,#+1
     85            }
   \                     ??savetext_9:
   \   000001A8   D0019FE5           LDR      R0,??savetext_0+0x18  ;; usp
   \   000001AC   000090E5           LDR      R0,[R0, #+0]
   \   000001B0   00005BE1           CMP      R11,R0
   \   000001B4   E6FFFF1A           BNE      ??savetext_10
     86            p=dsp;
   \   000001B8   C4019FE5           LDR      R0,??savetext_0+0x1C  ;; dsp
   \   000001BC   00B090E5           LDR      R11,[R0, #+0]
   \   000001C0   140000EA           B        ??savetext_13
     87            while(p!=STKSZ)
     88            {
     89              //Пишем нижний стек из ОЗУ
     90              c=dstk[p];
   \                     ??savetext_14:
   \   000001C4   BC019FE5           LDR      R0,??savetext_0+0x20  ;; dstk
   \   000001C8   000090E5           LDR      R0,[R0, #+0]
   \   000001CC   0000DBE7           LDRB     R0,[R11, +R0]
     91              if (!c) c=0x0D;
   \   000001D0   0010B0E1           MOVS     R1,R0
   \   000001D4   0D00A003           MOVEQ    R0,#+13
     92              obuf[i]=c;
   \   000001D8   0500CAE7           STRB     R0,[R10, +R5]
     93              i++;
     94              flush_obuf(f,i);
   \   000001DC   000096E5           LDR      R0,[R6, #+0]
   \   000001E0   01A08AE2           ADD      R10,R10,#+1
   \   000001E4   00005AE1           CMP      R10,R0
   \   000001E8   0900003A           BCC      ??savetext_15
   \   000001EC   0D30A0E1           MOV      R3,SP
   \   000001F0   0A20A0E1           MOV      R2,R10
   \   000001F4   0510A0E1           MOV      R1,R5
   \   000001F8   0700A0E1           MOV      R0,R7
   \   000001FC   0C0000EF           SWI      +12
   \   00000200   0A0050E1           CMP      R0,R10
   \   00000204   0100000A           BEQ      ??savetext_16
   \   00000208   0400A0E3           MOV      R0,#+4
   \   0000020C   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
   \                     ??savetext_16:
   \   00000210   00A0A0E3           MOV      R10,#+0
     95              p++;
   \                     ??savetext_15:
   \   00000214   01B08BE2           ADD      R11,R11,#+1
     96            }
   \                     ??savetext_13:
   \   00000218   6C019FE5           LDR      R0,??savetext_0+0x24  ;; STKSZ
   \   0000021C   000090E5           LDR      R0,[R0, #+0]
   \   00000220   00005BE1           CMP      R11,R0
   \   00000224   E6FFFF1A           BNE      ??savetext_14
     97            if (fwrite(f,obuf,i,&ul)!=i) DiskErrorMsg(4); //Недобиток
   \   00000228   0D30A0E1           MOV      R3,SP
   \   0000022C   0A20A0E1           MOV      R2,R10
   \   00000230   0510A0E1           MOV      R1,R5
   \   00000234   0700A0E1           MOV      R0,R7
   \   00000238   0C0000EF           SWI      +12
   \   0000023C   0A0050E1           CMP      R0,R10
   \   00000240   0100000A           BEQ      ??savetext_17
   \   00000244   0400A0E3           MOV      R0,#+4
   \   00000248   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
     98            i=d_disk;
   \                     ??savetext_17:
   \   0000024C   3C019FE5           LDR      R0,??savetext_0+0x28  ;; d_disk
   \   00000250   00A090E5           LDR      R10,[R0, #+0]
   \   00000254   00005AE3           CMP      R10,#+0
   \   00000258   2F00004A           BMI      ??savetext_18
     99            while(i>=0)
    100            {
    101              //Пишем нижний стек
    102              p=dbat[i--];
   \                     ??savetext_19:
   \   0000025C   30019FE5           LDR      R0,??savetext_0+0x2C  ;; dbat
    103              seekpos=STKSZ50*p;
   \   00000260   001096E5           LDR      R1,[R6, #+0]
   \   00000264   0A0190E7           LDR      R0,[R0, +R10, LSL #+2]
   \   00000268   01A04AE2           SUB      R10,R10,#+1
   \   0000026C   90010BE0           MUL      R11,R0,R1
    104              if (lseek(sf,seekpos,0,&ul,&ul)!=seekpos) DiskErrorMsg(2);
   \   00000270   0D00A0E1           MOV      R0,SP
   \   00000274   01002DE9           PUSH     {R0}
   \   00000278   04308DE2           ADD      R3,SP,#+4
   \   0000027C   0020A0E3           MOV      R2,#+0
   \   00000280   0B10A0E1           MOV      R1,R11
   \   00000284   0800A0E1           MOV      R0,R8
   \   00000288   0F0000EF           SWI      +15
   \   0000028C   0B0050E1           CMP      R0,R11
   \   00000290   04D08DE2           ADD      SP,SP,#+4
   \   00000294   0100000A           BEQ      ??savetext_20
   \   00000298   0200A0E3           MOV      R0,#+2
   \   0000029C   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
    105              if (fread(sf,ibuf,STKSZ50,&ul)!=STKSZ50) DiskErrorMsg(0);
   \                     ??savetext_20:
   \   000002A0   002096E5           LDR      R2,[R6, #+0]
   \   000002A4   0D30A0E1           MOV      R3,SP
   \   000002A8   0410A0E1           MOV      R1,R4
   \   000002AC   0800A0E1           MOV      R0,R8
   \   000002B0   0B0000EF           SWI      +11
   \   000002B4   001096E5           LDR      R1,[R6, #+0]
   \   000002B8   010050E1           CMP      R0,R1
   \   000002BC   0100000A           BEQ      ??savetext_21
   \   000002C0   0000A0E3           MOV      R0,#+0
   \   000002C4   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
    106              p=0;
   \                     ??savetext_21:
   \   000002C8   00B0A0E3           MOV      R11,#+0
   \   000002CC   040000EA           B        ??savetext_22
    107              while(p!=STKSZ50)
    108              {
    109                if (!ibuf[p]) ibuf[p]=0x0D;
   \                     ??savetext_23:
   \   000002D0   04008BE0           ADD      R0,R11,R4
   \   000002D4   0010D0E5           LDRB     R1,[R0, #+0]
    110                p++;
   \   000002D8   01B08BE2           ADD      R11,R11,#+1
   \   000002DC   000051E3           CMP      R1,#+0
   \   000002E0   0090C005           STRBEQ   R9,[R0, #+0]
    111              }
   \                     ??savetext_22:
   \   000002E4   002096E5           LDR      R2,[R6, #+0]
   \   000002E8   02005BE1           CMP      R11,R2
   \   000002EC   F7FFFF1A           BNE      ??savetext_23
    112              if (fwrite(f,ibuf,STKSZ50,&ul)!=STKSZ50) DiskErrorMsg(4);
   \   000002F0   0D30A0E1           MOV      R3,SP
   \   000002F4   0410A0E1           MOV      R1,R4
   \   000002F8   0700A0E1           MOV      R0,R7
   \   000002FC   0C0000EF           SWI      +12
   \   00000300   001096E5           LDR      R1,[R6, #+0]
   \   00000304   010050E1           CMP      R0,R1
   \   00000308   0100000A           BEQ      ??savetext_24
   \   0000030C   0400A0E3           MOV      R0,#+4
   \   00000310   ........           _BLF     DiskErrorMsg,??DiskErrorMsg??rA
    113            }
   \                     ??savetext_24:
   \   00000314   00005AE3           CMP      R10,#+0
   \   00000318   CFFFFF5A           BPL      ??savetext_19
    114            fclose(sf,&ul); //Более ничего интересного в верхнем стеке
   \                     ??savetext_18:
   \   0000031C   0D10A0E1           MOV      R1,SP
   \   00000320   0800A0E1           MOV      R0,R8
   \   00000324   0D0000EF           SWI      +13
    115          LERR2:
    116            fclose(f,&ul);
   \   00000328   0D10A0E1           MOV      R1,SP
   \   0000032C   0700A0E1           MOV      R0,R7
   \   00000330   0D0000EF           SWI      +13
    117          LERR1:
    118            mfree(ibuf);
   \                     ??savetext_1:
   \   00000334   0400A0E1           MOV      R0,R4
   \   00000338   150000EF           SWI      +21
    119            mfree(obuf);
   \   0000033C   0500A0E1           MOV      R0,R5
   \   00000340   150000EF           SWI      +21
    120            disk_access=0;
   \   00000344   4C009FE5           LDR      R0,??savetext_0+0x30  ;; disk_access
   \   00000348   0010A0E3           MOV      R1,#+0
   \   0000034C   001080E5           STR      R1,[R0, #+0]
    121            draw_mode=1; //Перерисовываем
   \   00000350   44009FE5           LDR      R0,??savetext_0+0x34  ;; draw_mode
   \   00000354   0110A0E3           MOV      R1,#+1
   \   00000358   001080E5           STR      R1,[R0, #+0]
    122            REDRAW();
   \   0000035C   720100EF           SWI      +370
    123          }
   \   00000360   04D08DE2           ADD      SP,SP,#+4
   \   00000364   F08FBDE8           POP      {R4-R11,PC}      ;; return
   \                     ??savetext_0:
   \   00000368   ........           DC32     STKSZ50
   \   0000036C   ........           DC32     filename
   \   00000370   ........           DC32     stkfile
   \   00000374   ........           DC32     u_disk
   \   00000378   ........           DC32     ubat
   \   0000037C   ........           DC32     ustk
   \   00000380   ........           DC32     usp
   \   00000384   ........           DC32     dsp
   \   00000388   ........           DC32     dstk
   \   0000038C   ........           DC32     STKSZ
   \   00000390   ........           DC32     d_disk
   \   00000394   ........           DC32     dbat
   \   00000398   ........           DC32     disk_access
   \   0000039C   ........           DC32     draw_mode
    124          

   Maximum stack usage in bytes:

     Function CSTACK
     -------- ------
     savetext    44


   Segment part sizes:

     Function/Label Bytes
     -------------- -----
     savetext        928
      Others          16

 
 944 bytes in segment CODE
 
 928 bytes of CODE memory (+ 16 bytes shared)

Errors: none
Warnings: none
